
> @hasteCRM/api@0.0.1 test:cov /Users/haste/Cursor/hasteCRM/apps/api
> jest --coverage "--silent"

FAIL src/modules/auth/two-factor.service.additional.spec.ts
  ● TwoFactorService - Additional Coverage › setupTwoFactor - edge cases › should handle existing 2FA setup during setup

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

    @@ -1,7 +1,20 @@
      Object {
        "data": Object {
    +     "backupCodes": Array [
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +     ],
    +     "isEnabled": false,
          "secret": "new-secret",
        },
        "where": Object {
          "userId": "user-123",
        },,

    Number of calls: 1

      118 |       const result = await service.setupTwoFactor(userId, password);
      119 |
    > 120 |       expect(mockPrismaService.twoFactorAuth.update).toHaveBeenCalledWith({
          |                                                      ^
      121 |         where: { userId },
      122 |         data: { secret: "new-secret" },
      123 |       });

      at Object.<anonymous> (modules/auth/two-factor.service.additional.spec.ts:120:54)

  ● TwoFactorService - Additional Coverage › enableTwoFactor › should throw error when 2FA setup not found

    TypeError: service.enableTwoFactor is not a function

      134 |
      135 |       await expect(
    > 136 |         service.enableTwoFactor(userId, token),
          |                 ^
      137 |       ).rejects.toThrow(
      138 |         new BadRequestException("Two-factor authentication not set up"),
      139 |       );

      at Object.<anonymous> (modules/auth/two-factor.service.additional.spec.ts:136:17)

  ● TwoFactorService - Additional Coverage › enableTwoFactor › should throw error when 2FA is already enabled

    TypeError: service.enableTwoFactor is not a function

      151 |
      152 |       await expect(
    > 153 |         service.enableTwoFactor(userId, token),
          |                 ^
      154 |       ).rejects.toThrow(
      155 |         new BadRequestException("Two-factor authentication already enabled"),
      156 |       );

      at Object.<anonymous> (modules/auth/two-factor.service.additional.spec.ts:153:17)

  ● TwoFactorService - Additional Coverage › enableTwoFactor › should throw error when token is invalid

    TypeError: service.enableTwoFactor is not a function

      170 |
      171 |       await expect(
    > 172 |         service.enableTwoFactor(userId, token),
          |                 ^
      173 |       ).rejects.toThrow(new UnauthorizedException("Invalid verification code"));
      174 |     });
      175 |   });

      at Object.<anonymous> (modules/auth/two-factor.service.additional.spec.ts:172:17)

  ● TwoFactorService - Additional Coverage › disableTwoFactor › should successfully disable 2FA and delete backup codes

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"where": {"userId": "user-123"}}

    Number of calls: 0

      271 |       await service.disableTwoFactor(userId, password, token);
      272 |
    > 273 |       expect(mockPrismaService.twoFactorAuth.delete).toHaveBeenCalledWith({
          |                                                      ^
      274 |         where: { userId },
      275 |       });
      276 |       expect(mockPrismaService.twoFactorAuth.delete).toHaveBeenCalled();

      at Object.<anonymous> (modules/auth/two-factor.service.additional.spec.ts:273:54)

FAIL src/modules/health/metrics.controller.spec.ts
  ● MetricsController › getMetrics › should return system metrics

    expect(received).toEqual(expected) // deep equality

    - Expected  -  7
    + Received  + 18

      Object {
    -   "contacts": 100,
    +   "cpu": Object {
    +     "system": 0,
    +     "user": 1,
    +   },
        "database": Object {
    -     "size": "100MB",
    +     "activeConnections": 0,
        },
    -   "emails": 500,
    +   "memory": Object {
    +     "external": 6,
    +     "heapTotal": 83,
    +     "heapUsed": 62,
    +     "rss": 206,
    +   },
        "redis": Object {
    -     "keys": 100,
    -     "memory": "1M",
    +     "connectedClients": undefined,
    +     "usedMemory": undefined,
    +   },
    +   "requests": Object {
    +     "avgResponseTime": 0,
    +     "errors": 0,
    +     "total": 0,
        },
        "timestamp": Any<String>,
        "uptime": Any<Number>,
    -   "users": 10,
    -   "workspaces": 5,
      }

      54 |       const result = await controller.getMetrics();
      55 |
    > 56 |       expect(result).toEqual({
         |                      ^
      57 |         users: 10,
      58 |         workspaces: 5,
      59 |         contacts: 100,

      at Object.<anonymous> (modules/health/metrics.controller.spec.ts:56:22)

[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Unhandled exception: Something went wrong
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Error: Something went wrong
    at Object.<anonymous> (/Users/haste/Cursor/hasteCRM/apps/api/src/common/filters/all-exceptions.filter.spec.ts:124:25)
    at Promise.then.completed (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Object:
{
  "statusCode": 500,
  "path": "/api/test",
  "requestId": "req-123",
  "userId": "user-123",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "Mozilla/5.0"
}

[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Unhandled exception: Unknown database error
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] PrismaClientKnownRequestError: Unknown database error
    at Object.<anonymous> (/Users/haste/Cursor/hasteCRM/apps/api/src/common/filters/all-exceptions.filter.spec.ts:176:30)
    at Promise.then.completed (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Object:
{
  "statusCode": 500,
  "path": "/api/test",
  "requestId": "req-123",
  "userId": "user-123",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "Mozilla/5.0"
}

[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Unhandled exception: Test error
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Error: Test error
    at TestFile.js:123
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Object:
{
  "statusCode": 500,
  "path": "/api/test",
  "requestId": "req-123",
  "userId": "user-123",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "Mozilla/5.0"
}

[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Unhandled exception: Test error
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Error: Test error
    at TestFile.js:123
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Object:
{
  "statusCode": 500,
  "path": "/api/test",
  "requestId": "req-123",
  "userId": "user-123",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "Mozilla/5.0"
}

[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Unhandled exception: An unexpected error occurred
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] undefined
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Object:
{
  "statusCode": 500,
  "path": "/api/test",
  "requestId": "req-123",
  "userId": "user-123",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "Mozilla/5.0"
}

[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Unhandled exception: GraphQL generic error
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Error: GraphQL generic error
    at Object.<anonymous> (/Users/haste/Cursor/hasteCRM/apps/api/src/common/filters/all-exceptions.filter.spec.ts:293:25)
    at Promise.then.completed (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/Users/haste/Cursor/hasteCRM/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[Nest] 76281  - 06/15/2025, 10:42:06 AM   ERROR [AllExceptionsFilter] Object:
{
  "statusCode": 500,
  "path": "testQuery",
  "requestId": "req-123",
  "userId": "user-123",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "Mozilla/5.0"
}

FAIL src/common/filters/all-exceptions.filter.spec.ts
  ● AllExceptionsFilter › HTTP Exceptions › should handle unknown Prisma error codes

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"error": "Database error", "message": "Unknown database error", "statusCode": 500}
    Received: {"message": "Unknown database error", "path": "/api/test", "requestId": "req-123", "statusCode": 500, "timestamp": "2025-06-15T14:42:06.806Z"}

    Number of calls: 1

      181 |
      182 |       expect(mockResponse.status).toHaveBeenCalledWith(HttpStatus.INTERNAL_SERVER_ERROR);
    > 183 |       expect(mockResponse.json).toHaveBeenCalledWith(
          |                                 ^
      184 |         expect.objectContaining({
      185 |           statusCode: HttpStatus.INTERNAL_SERVER_ERROR,
      186 |           message: "Unknown database error",

      at Object.<anonymous> (common/filters/all-exceptions.filter.spec.ts:183:33)

PASS src/modules/contacts/contacts.resolver.spec.ts
[Nest] 76291  - 06/15/2025, 10:42:07 AM   ERROR [MessageFetchProcessor] Failed to fetch message msg-789:
[Nest] 76291  - 06/15/2025, 10:42:07 AM   ERROR [MessageFetchProcessor] Error: Fetch failed
[Nest] 76291  - 06/15/2025, 10:42:07 AM   ERROR [MessageFetchProcessor] Failed to download attachment attach-789:
[Nest] 76291  - 06/15/2025, 10:42:07 AM   ERROR [MessageFetchProcessor] Error: Download failed
[Nest] 76291  - 06/15/2025, 10:42:07 AM   ERROR [MessageFetchProcessor] Full sync failed for account account-456:
[Nest] 76291  - 06/15/2025, 10:42:07 AM   ERROR [MessageFetchProcessor] Error: Full sync failed
[Nest] 76292  - 06/15/2025, 10:42:07 AM   ERROR [GmailSyncService] Sync failed for user@example.com:
[Nest] 76292  - 06/15/2025, 10:42:07 AM   ERROR [GmailSyncService] Error: API Error
[Nest] 76289  - 06/15/2025, 10:42:07 AM   ERROR [WebhookRecoveryService] Webhook processing failed for account account-1:
[Nest] 76289  - 06/15/2025, 10:42:07 AM   ERROR [WebhookRecoveryService] Error: Webhook processing failed
[Nest] 76289  - 06/15/2025, 10:42:07 AM   ERROR [WebhookRecoveryService] Webhook processing failed for account account-1:
[Nest] 76289  - 06/15/2025, 10:42:07 AM   ERROR [WebhookRecoveryService] Error: Webhook processing failed
[Nest] 76289  - 06/15/2025, 10:42:07 AM   ERROR [WebhookRecoveryService] Webhook processing failed for account non-existent:
[Nest] 76289  - 06/15/2025, 10:42:07 AM   ERROR [WebhookRecoveryService] Error: Webhook processing failed
[Nest] 76289  - 06/15/2025, 10:42:07 AM   ERROR [WebhookRecoveryService] Webhook processing failed for account account-1:
[Nest] 76289  - 06/15/2025, 10:42:07 AM   ERROR [WebhookRecoveryService] Error: First webhook failure
PASS src/modules/gmail/processors/message-fetch.processor.spec.ts
PASS src/modules/gmail/gmail-sync.service.spec.ts
PASS src/modules/webhooks/webhook-recovery.service.spec.ts
PASS src/common/utils/notification.spec.ts
PASS src/modules/gmail/gmail.service.spec.ts
[Nest] 76282  - 06/15/2025, 10:42:07 AM   ERROR [HistorySyncProcessor] History sync failed for account account-123:
[Nest] 76282  - 06/15/2025, 10:42:07 AM   ERROR [HistorySyncProcessor] Error: Sync failed
[Nest] 76282  - 06/15/2025, 10:42:07 AM   ERROR [HistorySyncProcessor] History sync failed for account account-123:
[Nest] 76282  - 06/15/2025, 10:42:07 AM   ERROR [HistorySyncProcessor] Object:
{
  "code": 500
}

PASS src/modules/gmail/gmail.service.additional.spec.ts
PASS src/modules/gmail/processors/history-sync.processor.spec.ts
PASS src/modules/auth/session.service.spec.ts
PASS src/modules/gmail/resolvers/email.resolver.spec.ts
PASS src/modules/webhooks/gmail-webhook.controller.spec.ts
PASS src/modules/gmail/resolvers/email-account.resolver.spec.ts
PASS src/modules/gmail/gmail-history.service.spec.ts
PASS src/modules/health/health.controller.spec.ts
[Nest] 76285  - 06/15/2025, 10:42:08 AM   ERROR [PipelineAutomationService] Failed to execute action SEND_EMAIL for automation automation-123
[Nest] 76285  - 06/15/2025, 10:42:08 AM   ERROR [PipelineAutomationService] Error: No contacts found for deal
[Nest] 76285  - 06/15/2025, 10:42:08 AM   ERROR [PipelineAutomationService] Failed to execute action CREATE_TASK for automation automation-123
[Nest] 76285  - 06/15/2025, 10:42:08 AM   ERROR [PipelineAutomationService] Error: Task creation failed
PASS src/modules/pipelines/pipeline-automation.service.spec.ts
PASS src/modules/companies/companies.resolver.spec.ts
PASS src/modules/import-export/dto/import-contacts.input.spec.ts
[Nest] 76283  - 06/15/2025, 10:42:08 AM   ERROR [GmailWebhookService] No account found for email: test@example.com
[Nest] 76283  - 06/15/2025, 10:42:08 AM   ERROR [GmailWebhookService] Failed to process Gmail notification:
[Nest] 76283  - 06/15/2025, 10:42:08 AM   ERROR [GmailWebhookService] Error: Queue error
PASS src/modules/webhooks/gmail-webhook.service.spec.ts
PASS src/modules/contacts/dto/contact-filters.input.spec.ts
PASS src/modules/auth/auth.module.spec.ts
PASS src/modules/auth/auth.controller.spec.ts
PASS src/modules/ai/ai.resolver.spec.ts
PASS src/common/filters/validation-exception.filter.spec.ts
PASS src/modules/redis/redis.service.spec.ts
PASS src/modules/gmail/gmail.module.spec.ts
FAIL src/modules/ai/ai.module.spec.ts
  ● AiModule › should compile the module

    Nest can't resolve dependencies of the AiService (?, EmailService, ContactsService, PrismaService). Please make sure that the argument ConfigService at index [0] is available in the AiModule context.

    Potential solutions:
    - Is AiModule a valid NestJS module?
    - If ConfigService is a provider, is it part of the current AiModule?
    - If ConfigService is exported from a separate @Module, is that module imported within AiModule?
      @Module({
        imports: [ /* the Module containing ConfigService */ ]
      })

      4 | describe("AiModule", () => {
      5 |   it("should compile the module", async () => {
    > 6 |     const module = await Test.createTestingModule({
        |                    ^
      7 |       imports: [AiModule],
      8 |     }).compile();
      9 |

      at TestingInjector.lookupComponentInParentModules (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:262:19)
      at TestingInjector.resolveComponentInstance (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:215:33)
      at TestingInjector.resolveComponentInstance (../../../node_modules/.pnpm/@nestjs+testing@10.4.19_@nestjs+common@10.4.19_@nestjs+core@10.4.19_@nestjs+platform-express@10.4.19/node_modules/@nestjs/testing/testing-injector.js:19:45)
      at resolveParam (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:129:38)
          at async Promise.all (index 0)
      at TestingInjector.resolveConstructorParams (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:144:27)
      at TestingInjector.loadInstance (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:70:13)
      at TestingInjector.loadProvider (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:98:9)
      at ../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:56:13
          at async Promise.all (index 3)
      at TestingInstanceLoader.createInstancesOfProviders (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:55:9)
      at ../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:40:13
          at async Promise.all (index 2)
      at TestingInstanceLoader.createInstances (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:39:9)
      at TestingInstanceLoader.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:22:13)
      at TestingInstanceLoader.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+testing@10.4.19_@nestjs+common@10.4.19_@nestjs+core@10.4.19_@nestjs+platform-express@10.4.19/node_modules/@nestjs/testing/testing-instance-loader.js:9:9)
      at TestingModuleBuilder.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+testing@10.4.19_@nestjs+common@10.4.19_@nestjs+core@10.4.19_@nestjs+platform-express@10.4.19/node_modules/@nestjs/testing/testing-module.builder.js:118:9)
      at TestingModuleBuilder.compile (../../../node_modules/.pnpm/@nestjs+testing@10.4.19_@nestjs+common@10.4.19_@nestjs+core@10.4.19_@nestjs+platform-express@10.4.19/node_modules/@nestjs/testing/testing-module.builder.js:74:9)
      at Object.<anonymous> (modules/ai/ai.module.spec.ts:6:20)

PASS src/common/interceptors/error-logging.interceptor.spec.ts
PASS src/modules/pipelines/pipelines.resolver.spec.ts
PASS src/modules/auth/auth.service.oauth.spec.ts
PASS src/modules/auth/auth.service.spec.ts
PASS src/modules/gmail/email-account.service.spec.ts
[Nest] 76290  - 06/15/2025, 10:42:08 AM   ERROR [AiService] Failed to summarize email
[Nest] 76290  - 06/15/2025, 10:42:08 AM   ERROR [AiService] Error: Email not found
PASS src/modules/health/indicators/prisma.health.spec.ts
PASS src/modules/auth/strategies/google.strategy.spec.ts
[Nest] 76290  - 06/15/2025, 10:42:08 AM   ERROR [AiService] Failed to summarize email
[Nest] 76290  - 06/15/2025, 10:42:08 AM   ERROR [AiService] Error: API Error
[Nest] 76290  - 06/15/2025, 10:42:08 AM   ERROR [AiService] Failed to generate smart compose
[Nest] 76290  - 06/15/2025, 10:42:08 AM   ERROR [AiService] Error: Email not found
PASS src/common/interceptors/logging.interceptor.spec.ts
[Nest] 76290  - 06/15/2025, 10:42:08 AM   ERROR [AiService] Failed to enrich contact
[Nest] 76290  - 06/15/2025, 10:42:08 AM   ERROR [AiService] Error: Contact not found
[Nest] 76290  - 06/15/2025, 10:42:08 AM   ERROR [AiService] Failed to enrich contact
[Nest] 76290  - 06/15/2025, 10:42:08 AM   ERROR [AiService] Error: API Error
PASS src/modules/health/indicators/redis.health.spec.ts
PASS src/modules/auth/strategies/local.strategy.spec.ts
PASS src/modules/ai/ai.service.spec.ts
PASS src/modules/auth/two-factor.controller.spec.ts
PASS src/modules/auth/auth.service.additional.spec.ts
PASS src/modules/import-export/import-export.service.spec.ts
PASS src/modules/pipelines/processors/automation.processor.spec.ts
PASS src/common/guards/custom-gql-auth.guard.spec.ts
PASS src/modules/companies/entities/company.entity.spec.ts
PASS src/modules/pipelines/pipeline-analytics.service.spec.ts
PASS src/modules/auth/strategies/jwt.strategy.spec.ts
PASS src/modules/prisma/prisma.service.spec.ts
PASS src/modules/auth/strategies/refresh-jwt.strategy.spec.ts
PASS src/modules/pipelines/deals.service.spec.ts
PASS src/modules/pipelines/pipelines.service.spec.ts
PASS src/modules/companies/companies.service.spec.ts
PASS src/modules/contacts/entities/contact.entity.spec.ts
PASS src/modules/gmail/email.service.spec.ts
PASS src/modules/email/email.module.spec.ts
PASS src/modules/health/health.resolver.spec.ts
PASS src/modules/auth/auth.service.missing.spec.ts
PASS src/common/guards/local-auth.guard.spec.ts
PASS src/modules/auth/session.controller.spec.ts
PASS src/modules/auth/two-factor.service.spec.ts
PASS src/modules/email/email.service.spec.ts
PASS src/common/utils/helpers.spec.ts
PASS src/common/utils/utils.spec.ts
PASS src/modules/contacts/contacts.service.spec.ts
PASS src/common/utils/pagination.spec.ts
PASS src/common/config/rate-limits.spec.ts
PASS src/common/utils/crypto.spec.ts
PASS src/common/exceptions/business.exception.spec.ts
PASS src/modules/prisma/prisma.module.spec.ts
PASS src/modules/webhooks/guards/pubsub-auth.guard.spec.ts
PASS src/common/guards/rate-limit.guard.spec.ts
PASS src/modules/gmail/email-parser.service.spec.ts
PASS src/common/filters/http-exception.filter.spec.ts
FAIL src/modules/import-export/import-export.resolver.spec.ts
  ● Test suite failed to run

    Cannot find module './import-export.service' from 'modules/import-export/import-export.resolver.spec.ts'

      1 | import { Test, TestingModule } from "@nestjs/testing";
      2 | import { ImportExportResolver } from "./import-export.resolver";
    > 3 | import { ImportExportService } from "./import-export.service";
        | ^
      4 |
      5 | describe("ImportExportResolver", () => {
      6 |   let resolver: ImportExportResolver;

      at Resolver._throwModNotFoundError (../../../node_modules/.pnpm/jest-resolve@29.7.0/node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (modules/import-export/import-export.resolver.spec.ts:3:1)

FAIL src/main.spec.ts
  ● Main Bootstrap › bootstrap on module run › should call bootstrap when run as main module

    TypeError: Cannot assign to read only property 'main' of function 'function () { [native code] }'

      383 |       const originalMain = require.main;
      384 |       const mockModule = { id: "test-main", filename: "test-main.js" };
    > 385 |       require.main = mockModule as any;
          |                   ^
      386 |       
      387 |       // Re-require to trigger the conditional check
      388 |       jest.isolateModules(() => {

      at Object.<anonymous> (main.spec.ts:385:19)

FAIL src/app.module.spec.ts (5.13 s)
  ● AppModule › GraphQL Context › should add Passport methods to request object if missing

    expect(received).toBeDefined()

    Received: undefined

      219 |       // Extract the context function
      220 |       const contextFn = graphQLModule?.context;
    > 221 |       expect(contextFn).toBeDefined();
          |                         ^
      222 |
      223 |       // Test with request missing Passport methods
      224 |       const req: any = {};

      at Object.<anonymous> (app.module.spec.ts:221:25)

  ● AppModule › GraphQL Context › should preserve existing Passport methods

    TypeError: contextFn is not a function

      267 |       const res = {};
      268 |       
    > 269 |       const context = contextFn({ req, res });
          |                       ^
      270 |
      271 |       expect(req.login).toBe(mockLogin);
      272 |       expect(req.logIn).toBe(mockLogin);

      at Object.<anonymous> (app.module.spec.ts:269:23)

  ● AppModule › GraphQL Context › should handle null request

    TypeError: contextFn is not a function

      291 |       const req = null;
      292 |       const res = {};
    > 293 |       const context = contextFn({ req, res });
          |                       ^
      294 |
      295 |       expect(context).toEqual({ req, res });
      296 |     });

      at Object.<anonymous> (app.module.spec.ts:293:23)

  ● AppModule › GraphQL Context › should handle authenticated user

    TypeError: contextFn is not a function

      314 |       
      315 |       // Call the context function which should add the methods
    > 316 |       const context = contextFn({ req, res });
          |                       ^
      317 |
      318 |       // Verify that isAuthenticated was added and returns true
      319 |       expect(req.isAuthenticated).toBeDefined();

      at Object.<anonymous> (app.module.spec.ts:316:23)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
------------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------
File                                | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                 
------------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------
All files                           |   92.03 |    79.83 |   78.47 |   91.69 |                                                                   
 src                                |   85.13 |    53.84 |      60 |   85.91 |                                                                   
  app.module.ts                     |   68.75 |    26.66 |       0 |   68.96 | 44-59                                                             
  main.ts                           |   97.61 |     90.9 |     100 |   97.61 | 104                                                               
 src/common/config                  |     100 |      100 |     100 |     100 |                                                                   
  rate-limits.ts                    |     100 |      100 |     100 |     100 |                                                                   
 src/common/decorators              |     100 |      100 |     100 |     100 |                                                                   
  rate-limit.decorator.ts           |     100 |      100 |     100 |     100 |                                                                   
 src/common/exceptions              |     100 |      100 |     100 |     100 |                                                                   
  business.exception.ts             |     100 |      100 |     100 |     100 |                                                                   
 src/common/filters                 |     100 |    94.23 |     100 |     100 |                                                                   
  all-exceptions.filter.ts          |     100 |    93.75 |     100 |     100 | 92,137                                                            
  http-exception.filter.ts          |     100 |     90.9 |     100 |     100 | 70                                                                
  validation-exception.filter.ts    |     100 |      100 |     100 |     100 |                                                                   
 src/common/guards                  |     100 |    88.09 |     100 |     100 |                                                                   
  custom-gql-auth.guard.ts          |     100 |    88.23 |     100 |     100 | 14                                                                
  jwt-auth.guard.ts                 |     100 |      100 |     100 |     100 |                                                                   
  local-auth.guard.ts               |     100 |      100 |     100 |     100 |                                                                   
  rate-limit.guard.ts               |     100 |       88 |     100 |     100 | 23,89                                                             
  refresh-jwt-auth.guard.ts         |     100 |      100 |     100 |     100 |                                                                   
 src/common/interceptors            |   97.43 |     90.9 |   94.11 |   98.59 |                                                                   
  error-logging.interceptor.ts      |   95.23 |     90.9 |   88.88 |   97.29 | 85                                                                
  logging.interceptor.ts            |     100 |     90.9 |     100 |     100 | 49                                                                
 src/common/utils                   |     100 |      100 |     100 |     100 |                                                                   
  crypto.ts                         |     100 |      100 |     100 |     100 |                                                                   
  helpers.ts                        |     100 |      100 |     100 |     100 |                                                                   
  index.ts                          |     100 |      100 |     100 |     100 |                                                                   
  notification.ts                   |     100 |      100 |     100 |     100 |                                                                   
  pagination.ts                     |     100 |      100 |     100 |     100 |                                                                   
 src/modules/ai                     |   96.09 |    72.54 |   94.73 |    95.9 |                                                                   
  ai.module.ts                      |     100 |       50 |     100 |     100 | 17                                                                
  ai.resolver.ts                    |     100 |       75 |     100 |     100 | 9-56                                                              
  ai.service.ts                     |   94.84 |     72.5 |   92.85 |   94.73 | 171-174,291                                                       
 src/modules/auth                   |   99.32 |       87 |   98.68 |    99.3 |                                                                   
  auth.controller.ts                |   96.29 |    72.41 |    92.3 |   96.15 | 40-41                                                             
  auth.module.ts                    |     100 |       50 |     100 |     100 | 26                                                                
  auth.service.ts                   |     100 |    89.33 |     100 |     100 | 24-27,101,526,568                                                 
  session.controller.ts             |     100 |       75 |     100 |     100 | 18                                                                
  session.service.ts                |     100 |    92.85 |     100 |     100 | 23                                                                
  two-factor.controller.ts          |     100 |    85.71 |     100 |     100 | 19                                                                
  two-factor.service.ts             |   99.02 |    93.47 |     100 |   98.98 | 150                                                               
 src/modules/auth/dto               |     100 |      100 |     100 |     100 |                                                                   
  login.dto.ts                      |     100 |      100 |     100 |     100 |                                                                   
  register.dto.ts                   |     100 |      100 |     100 |     100 |                                                                   
  two-factor.dto.ts                 |     100 |      100 |     100 |     100 |                                                                   
 src/modules/auth/strategies        |   98.43 |    82.35 |     100 |   98.21 |                                                                   
  google.strategy.ts                |     100 |     87.5 |     100 |     100 | 8                                                                 
  jwt.strategy.ts                   |   94.44 |    76.92 |     100 |   93.75 | 30                                                                
  local.strategy.ts                 |     100 |       80 |     100 |     100 | 8                                                                 
  refresh-jwt.strategy.ts           |     100 |     87.5 |     100 |     100 | 15                                                                
 src/modules/companies              |   83.78 |    77.27 |      52 |   82.08 |                                                                   
  companies.module.ts               |     100 |       50 |     100 |     100 | 14                                                                
  companies.resolver.ts             |   72.72 |       75 |   36.84 |   70.73 | 13,22,24-25,33,35,42,44,52,54,66,69                               
  companies.service.ts              |     100 |     87.5 |     100 |     100 | 8                                                                 
 src/modules/companies/dto          |      92 |      100 |       0 |    91.3 |                                                                   
  create-company.input.ts           |      92 |      100 |       0 |    91.3 | 49,55                                                             
 src/modules/companies/entities     |   90.32 |       75 |       0 |   89.65 |                                                                   
  company.entity.ts                 |   90.32 |       75 |       0 |   89.65 | 5,32,35                                                           
 src/modules/contacts               |   84.89 |    80.85 |   54.34 |   83.96 |                                                                   
  contacts.module.ts                |     100 |       50 |     100 |     100 | 14                                                                
  contacts.resolver.ts              |   69.11 |       75 |   34.37 |   67.69 | 15,24,27-28,35,37,44,48-49,56,66,68,75,77,84,86-87,94,96,108,111  
  contacts.service.ts               |     100 |       88 |     100 |     100 | 10-31                                                             
 src/modules/contacts/dto           |   91.48 |       75 |       0 |   90.24 |                                                                   
  contact-filters.input.ts          |   82.35 |       75 |       0 |      80 | 12,17,27                                                          
  create-contact.input.ts           |     100 |      100 |     100 |     100 |                                                                   
  update-contact.input.ts           |    87.5 |      100 |       0 |   83.33 | 7                                                                 
 src/modules/contacts/entities      |    90.9 |    77.41 |      20 |   90.47 |                                                                   
  contact.entity.ts                 |    90.9 |    77.41 |      20 |   90.47 | 16,76,79,82                                                       
 src/modules/email                  |     100 |      100 |     100 |     100 |                                                                   
  email.module.ts                   |     100 |      100 |     100 |     100 |                                                                   
  email.service.ts                  |     100 |      100 |     100 |     100 |                                                                   
 src/modules/gmail                  |   80.36 |    72.57 |   80.45 |   79.76 |                                                                   
  email-account.service.ts          |     100 |    83.33 |     100 |     100 | 11                                                                
  email-parser.service.ts           |    81.3 |    71.42 |      70 |   81.18 | 82-83,120,167,257-259,289-344                                     
  email.service.ts                  |     100 |    96.42 |     100 |     100 | 46                                                                
  gmail-history.service.ts          |      72 |    60.86 |   83.33 |   71.23 | 167-173,180-187,193-200,240-270                                   
  gmail-sync.service.ts             |   66.66 |    69.56 |      50 |   65.82 | 46,64,79-80,116,138,211-278                                       
  gmail.module.ts                   |     100 |       50 |     100 |     100 | 26                                                                
  gmail.service.ts                  |   69.84 |    72.72 |   66.66 |   68.85 | 158-217,257-269,324-326                                           
 src/modules/gmail/processors       |     100 |    83.33 |     100 |     100 |                                                                   
  history-sync.processor.ts         |     100 |    81.81 |     100 |     100 | 19                                                                
  message-fetch.processor.ts        |     100 |    85.71 |     100 |     100 | 30                                                                
 src/modules/gmail/resolvers        |   86.15 |    70.54 |   68.57 |   85.48 |                                                                   
  email-account.resolver.ts         |   84.61 |    76.19 |      60 |   83.78 | 24,49,59,68,77-78                                                 
  email.resolver.ts                 |   86.81 |    67.81 |      75 |    86.2 | 28-29,52,76-77,165,189,240,261,276,285,306                        
 src/modules/health                 |   89.28 |     65.3 |   85.71 |      88 |                                                                   
  health.controller.ts              |     100 |       75 |     100 |     100 | 14-17                                                             
  health.module.ts                  |     100 |      100 |     100 |     100 |                                                                   
  health.resolver.ts                |   85.71 |      100 |      50 |      80 | 5                                                                 
  metrics.controller.ts             |   78.37 |    58.62 |   66.66 |   77.14 | 84-86,145,163-172                                                 
 src/modules/health/indicators      |   96.55 |    77.14 |     100 |   96.29 |                                                                   
  prisma.health.ts                  |   96.42 |    58.33 |     100 |   96.15 | 82                                                                
  redis.health.ts                   |   96.66 |    86.95 |     100 |   96.42 | 25                                                                
 src/modules/import-export          |   73.25 |    70.83 |       5 |   70.51 |                                                                   
  import-export.module.ts           |     100 |       50 |     100 |     100 | 17                                                                
  import-export.resolver.ts         |   68.91 |    71.73 |       5 |   66.17 | 20,26-36,41-51,56-60,65-66,77,80,83,86,98,116,119,122,125,128,149 
 src/modules/import-export/dto      |   83.33 |       50 |       0 |   78.57 |                                                                   
  import-contacts.input.ts          |   83.33 |       50 |       0 |   78.57 | 17,28,32                                                          
 src/modules/import-export/services |   84.26 |    74.41 |      80 |   83.52 |                                                                   
  contact-export.service.ts         |   82.05 |    76.19 |      75 |   81.08 | 87-88,97,120-131                                                  
  contact-import.service.ts         |      86 |    72.72 |   83.33 |   85.41 | 42,72,87,164-175                                                  
 src/modules/pipelines              |   93.77 |     86.4 |   78.51 |   94.09 |                                                                   
  deals.service.ts                  |     100 |    97.01 |     100 |     100 | 20,519                                                            
  pipeline-analytics.service.ts     |   92.59 |    78.78 |    87.5 |   92.23 | 216-220,258,445-450,456                                           
  pipeline-automation.service.ts    |     100 |    88.98 |     100 |     100 | 33-35,107,110-127,176,235-247                                     
  pipelines.module.ts               |     100 |       50 |     100 |     100 | 20                                                                
  pipelines.resolver.ts             |   72.94 |    76.85 |   48.88 |   74.35 | 32,39,59,67,83-86,98-101,113,120,134-139,174,201-202,211-212      
  pipelines.service.ts              |     100 |    98.03 |     100 |     100 | 11                                                                
 src/modules/pipelines/processors   |     100 |    83.33 |     100 |     100 |                                                                   
  automation.processor.ts           |     100 |    83.33 |     100 |     100 | 10                                                                
 src/modules/prisma                 |     100 |      100 |     100 |     100 |                                                                   
  prisma-client.ts                  |     100 |      100 |     100 |     100 |                                                                   
  prisma.module.ts                  |     100 |      100 |     100 |     100 |                                                                   
  prisma.service.ts                 |     100 |      100 |     100 |     100 |                                                                   
 src/modules/redis                  |   94.28 |    76.19 |   85.18 |   93.93 |                                                                   
  redis.module.ts                   |     100 |      100 |     100 |     100 |                                                                   
  redis.service.ts                  |   93.84 |    76.19 |   85.18 |   93.65 | 28,32,36,40                                                       
 src/modules/webhooks               |   96.25 |    73.03 |      88 |   96.05 |                                                                   
  gmail-webhook.controller.ts       |     100 |    77.27 |     100 |     100 | 41-49,89                                                          
  gmail-webhook.service.ts          |   89.65 |    65.78 |    62.5 |   89.28 | 165-178                                                           
  webhook-recovery.service.ts       |     100 |    81.48 |     100 |     100 | 14-16,188                                                         
  webhooks.module.ts                |     100 |       50 |     100 |     100 | 18                                                                
 src/modules/webhooks/guards        |     100 |      100 |     100 |     100 |                                                                   
  pubsub-auth.guard.ts              |     100 |      100 |     100 |     100 |                                                                   
------------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------
Summary of all failing tests
FAIL modules/auth/two-factor.service.additional.spec.ts
  ● TwoFactorService - Additional Coverage › setupTwoFactor - edge cases › should handle existing 2FA setup during setup

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

    @@ -1,7 +1,20 @@
      Object {
        "data": Object {
    +     "backupCodes": Array [
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +       undefined,
    +     ],
    +     "isEnabled": false,
          "secret": "new-secret",
        },
        "where": Object {
          "userId": "user-123",
        },,

    Number of calls: 1

      118 |       const result = await service.setupTwoFactor(userId, password);
      119 |
    > 120 |       expect(mockPrismaService.twoFactorAuth.update).toHaveBeenCalledWith({
          |                                                      ^
      121 |         where: { userId },
      122 |         data: { secret: "new-secret" },
      123 |       });

      at Object.<anonymous> (modules/auth/two-factor.service.additional.spec.ts:120:54)

  ● TwoFactorService - Additional Coverage › enableTwoFactor › should throw error when 2FA setup not found

    TypeError: service.enableTwoFactor is not a function

      134 |
      135 |       await expect(
    > 136 |         service.enableTwoFactor(userId, token),
          |                 ^
      137 |       ).rejects.toThrow(
      138 |         new BadRequestException("Two-factor authentication not set up"),
      139 |       );

      at Object.<anonymous> (modules/auth/two-factor.service.additional.spec.ts:136:17)

  ● TwoFactorService - Additional Coverage › enableTwoFactor › should throw error when 2FA is already enabled

    TypeError: service.enableTwoFactor is not a function

      151 |
      152 |       await expect(
    > 153 |         service.enableTwoFactor(userId, token),
          |                 ^
      154 |       ).rejects.toThrow(
      155 |         new BadRequestException("Two-factor authentication already enabled"),
      156 |       );

      at Object.<anonymous> (modules/auth/two-factor.service.additional.spec.ts:153:17)

  ● TwoFactorService - Additional Coverage › enableTwoFactor › should throw error when token is invalid

    TypeError: service.enableTwoFactor is not a function

      170 |
      171 |       await expect(
    > 172 |         service.enableTwoFactor(userId, token),
          |                 ^
      173 |       ).rejects.toThrow(new UnauthorizedException("Invalid verification code"));
      174 |     });
      175 |   });

      at Object.<anonymous> (modules/auth/two-factor.service.additional.spec.ts:172:17)

  ● TwoFactorService - Additional Coverage › disableTwoFactor › should successfully disable 2FA and delete backup codes

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"where": {"userId": "user-123"}}

    Number of calls: 0

      271 |       await service.disableTwoFactor(userId, password, token);
      272 |
    > 273 |       expect(mockPrismaService.twoFactorAuth.delete).toHaveBeenCalledWith({
          |                                                      ^
      274 |         where: { userId },
      275 |       });
      276 |       expect(mockPrismaService.twoFactorAuth.delete).toHaveBeenCalled();

      at Object.<anonymous> (modules/auth/two-factor.service.additional.spec.ts:273:54)

FAIL modules/health/metrics.controller.spec.ts
  ● MetricsController › getMetrics › should return system metrics

    expect(received).toEqual(expected) // deep equality

    - Expected  -  7
    + Received  + 18

      Object {
    -   "contacts": 100,
    +   "cpu": Object {
    +     "system": 0,
    +     "user": 1,
    +   },
        "database": Object {
    -     "size": "100MB",
    +     "activeConnections": 0,
        },
    -   "emails": 500,
    +   "memory": Object {
    +     "external": 6,
    +     "heapTotal": 83,
    +     "heapUsed": 62,
    +     "rss": 206,
    +   },
        "redis": Object {
    -     "keys": 100,
    -     "memory": "1M",
    +     "connectedClients": undefined,
    +     "usedMemory": undefined,
    +   },
    +   "requests": Object {
    +     "avgResponseTime": 0,
    +     "errors": 0,
    +     "total": 0,
        },
        "timestamp": Any<String>,
        "uptime": Any<Number>,
    -   "users": 10,
    -   "workspaces": 5,
      }

      54 |       const result = await controller.getMetrics();
      55 |
    > 56 |       expect(result).toEqual({
         |                      ^
      57 |         users: 10,
      58 |         workspaces: 5,
      59 |         contacts: 100,

      at Object.<anonymous> (modules/health/metrics.controller.spec.ts:56:22)

FAIL common/filters/all-exceptions.filter.spec.ts
  ● AllExceptionsFilter › HTTP Exceptions › should handle unknown Prisma error codes

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"error": "Database error", "message": "Unknown database error", "statusCode": 500}
    Received: {"message": "Unknown database error", "path": "/api/test", "requestId": "req-123", "statusCode": 500, "timestamp": "2025-06-15T14:42:06.806Z"}

    Number of calls: 1

      181 |
      182 |       expect(mockResponse.status).toHaveBeenCalledWith(HttpStatus.INTERNAL_SERVER_ERROR);
    > 183 |       expect(mockResponse.json).toHaveBeenCalledWith(
          |                                 ^
      184 |         expect.objectContaining({
      185 |           statusCode: HttpStatus.INTERNAL_SERVER_ERROR,
      186 |           message: "Unknown database error",

      at Object.<anonymous> (common/filters/all-exceptions.filter.spec.ts:183:33)

FAIL modules/ai/ai.module.spec.ts
  ● AiModule › should compile the module

    Nest can't resolve dependencies of the AiService (?, EmailService, ContactsService, PrismaService). Please make sure that the argument ConfigService at index [0] is available in the AiModule context.

    Potential solutions:
    - Is AiModule a valid NestJS module?
    - If ConfigService is a provider, is it part of the current AiModule?
    - If ConfigService is exported from a separate @Module, is that module imported within AiModule?
      @Module({
        imports: [ /* the Module containing ConfigService */ ]
      })

      4 | describe("AiModule", () => {
      5 |   it("should compile the module", async () => {
    > 6 |     const module = await Test.createTestingModule({
        |                    ^
      7 |       imports: [AiModule],
      8 |     }).compile();
      9 |

      at TestingInjector.lookupComponentInParentModules (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:262:19)
      at TestingInjector.resolveComponentInstance (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:215:33)
      at TestingInjector.resolveComponentInstance (../../../node_modules/.pnpm/@nestjs+testing@10.4.19_@nestjs+common@10.4.19_@nestjs+core@10.4.19_@nestjs+platform-express@10.4.19/node_modules/@nestjs/testing/testing-injector.js:19:45)
      at resolveParam (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:129:38)
          at async Promise.all (index 0)
      at TestingInjector.resolveConstructorParams (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:144:27)
      at TestingInjector.loadInstance (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:70:13)
      at TestingInjector.loadProvider (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:98:9)
      at ../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:56:13
          at async Promise.all (index 3)
      at TestingInstanceLoader.createInstancesOfProviders (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:55:9)
      at ../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:40:13
          at async Promise.all (index 2)
      at TestingInstanceLoader.createInstances (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:39:9)
      at TestingInstanceLoader.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+core@10.4.19_@nestjs+common@10.4.19_@nestjs+platform-express@10.4.19_reflect-metadata@0.1.14_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:22:13)
      at TestingInstanceLoader.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+testing@10.4.19_@nestjs+common@10.4.19_@nestjs+core@10.4.19_@nestjs+platform-express@10.4.19/node_modules/@nestjs/testing/testing-instance-loader.js:9:9)
      at TestingModuleBuilder.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+testing@10.4.19_@nestjs+common@10.4.19_@nestjs+core@10.4.19_@nestjs+platform-express@10.4.19/node_modules/@nestjs/testing/testing-module.builder.js:118:9)
      at TestingModuleBuilder.compile (../../../node_modules/.pnpm/@nestjs+testing@10.4.19_@nestjs+common@10.4.19_@nestjs+core@10.4.19_@nestjs+platform-express@10.4.19/node_modules/@nestjs/testing/testing-module.builder.js:74:9)
      at Object.<anonymous> (modules/ai/ai.module.spec.ts:6:20)

FAIL modules/import-export/import-export.resolver.spec.ts
  ● Test suite failed to run

    Cannot find module './import-export.service' from 'modules/import-export/import-export.resolver.spec.ts'

      1 | import { Test, TestingModule } from "@nestjs/testing";
      2 | import { ImportExportResolver } from "./import-export.resolver";
    > 3 | import { ImportExportService } from "./import-export.service";
        | ^
      4 |
      5 | describe("ImportExportResolver", () => {
      6 |   let resolver: ImportExportResolver;

      at Resolver._throwModNotFoundError (../../../node_modules/.pnpm/jest-resolve@29.7.0/node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (modules/import-export/import-export.resolver.spec.ts:3:1)

FAIL ./main.spec.ts
  ● Main Bootstrap › bootstrap on module run › should call bootstrap when run as main module

    TypeError: Cannot assign to read only property 'main' of function 'function () { [native code] }'

      383 |       const originalMain = require.main;
      384 |       const mockModule = { id: "test-main", filename: "test-main.js" };
    > 385 |       require.main = mockModule as any;
          |                   ^
      386 |       
      387 |       // Re-require to trigger the conditional check
      388 |       jest.isolateModules(() => {

      at Object.<anonymous> (main.spec.ts:385:19)

FAIL ./app.module.spec.ts (5.13 s)
  ● AppModule › GraphQL Context › should add Passport methods to request object if missing

    expect(received).toBeDefined()

    Received: undefined

      219 |       // Extract the context function
      220 |       const contextFn = graphQLModule?.context;
    > 221 |       expect(contextFn).toBeDefined();
          |                         ^
      222 |
      223 |       // Test with request missing Passport methods
      224 |       const req: any = {};

      at Object.<anonymous> (app.module.spec.ts:221:25)

  ● AppModule › GraphQL Context › should preserve existing Passport methods

    TypeError: contextFn is not a function

      267 |       const res = {};
      268 |       
    > 269 |       const context = contextFn({ req, res });
          |                       ^
      270 |
      271 |       expect(req.login).toBe(mockLogin);
      272 |       expect(req.logIn).toBe(mockLogin);

      at Object.<anonymous> (app.module.spec.ts:269:23)

  ● AppModule › GraphQL Context › should handle null request

    TypeError: contextFn is not a function

      291 |       const req = null;
      292 |       const res = {};
    > 293 |       const context = contextFn({ req, res });
          |                       ^
      294 |
      295 |       expect(context).toEqual({ req, res });
      296 |     });

      at Object.<anonymous> (app.module.spec.ts:293:23)

  ● AppModule › GraphQL Context › should handle authenticated user

    TypeError: contextFn is not a function

      314 |       
      315 |       // Call the context function which should add the methods
    > 316 |       const context = contextFn({ req, res });
          |                       ^
      317 |
      318 |       // Verify that isAuthenticated was added and returns true
      319 |       expect(req.isAuthenticated).toBeDefined();

      at Object.<anonymous> (app.module.spec.ts:316:23)


Test Suites: 7 failed, 70 passed, 77 total
Tests:       13 failed, 1112 passed, 1125 total
Snapshots:   0 total
Time:        6.51 s
 ELIFECYCLE  Command failed with exit code 1.
